<sfa-page-layout mode="card">
  <sfa-page-layout-header>
    <sfa-breadcrumbs
      *ngIf="isCreateMode()"
      [@fadeInRight]
      [crumbs]="['Orders', 'Order']"
      [crumbRoute]="['/orders/order']"
      current="Create Order"
    ></sfa-breadcrumbs>
    <sfa-breadcrumbs
      *ngIf="isUpdateMode()"
      [@fadeInRight]
      [crumbs]="['Orders', 'Order']"
      [crumbRoute]="['/orders/order']"
      current="Update Order"
    ></sfa-breadcrumbs>
  </sfa-page-layout-header>

  <sfa-page-layout-content [fxLayoutGap]="gap" fxLayout="column">
    <div
      [fxLayoutGap]="gap"
      fxFlex="noshrink"
      fxLayout="column"
      fxLayout.gt-sm="row"
      fxLayoutAlign.gt-sm="start stretch"
    >
      <sfa-card
        class="advanced-forms route-animations-elements"
        [@fadeInUp]
        fxFlex="auto"
      >
        <div *ngIf="form">
          <form [formGroup]="form" (ngSubmit)="save()" fxFlex>
            <div
              fxLayout="column"
              fxLayout.gt-sm="row"
              fxLayoutGap.gt-sm="16px"
            >
              <div fxLayout="column" fxFlex>
                <sfa-card-header>
                  <sfa-card-header-heading
                    >Order Details</sfa-card-header-heading
                  >
                </sfa-card-header>
                <sfa-card-content fxLayout="column" fxLayoutGap="8px">
                  <div class="result" fxLayout="column">
                    <mat-form-field
                      fxFlex
                      appearance="standard"
                      *ngIf="form.value.orderCode"
                    >
                      <mat-label>Order Code</mat-label>
                      <input
                        type="text"
                        formControlName="orderCode"
                        matInput
                        readonly
                      />
                    </mat-form-field>

                    <mat-form-field fxFlex appearance="standard">
                      <mat-label>Shop</mat-label>
                      <mat-select formControlName="shopId" required>
                        <mat-option
                          *ngFor="let shop of shops"
                          [value]="shop.id"
                          >{{ shop.name }}</mat-option
                        >
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field fxFlex appearance="standard">
                      <mat-label>Sales Rep</mat-label>
                      <mat-select
                        formControlName="salesRepId"
                        (ngModelChange)="
                          getAllItemBatches(form.value.salesRepId)
                        "
                        required
                      >
                        <mat-option
                          *ngFor="let salesRep of salesReps"
                          [value]="salesRep.id"
                          >{{ salesRep.userName }}</mat-option
                        >
                      </mat-select>
                    </mat-form-field>
                    <mat-form-field
                      class="sfa-flex-form-field"
                      fxFlex.gt-sm
                      appearance="standard"
                    >
                      <mat-label>Total Amount</mat-label>
                      <input
                        type="number"
                        formControlName="totalAmount"
                        matInput
                        readonly
                        required
                      />
                    </mat-form-field>
                  </div>
                </sfa-card-content>
              </div>
              <div fxLayout="column" fxFlex>
                <sfa-card-header>
                  <sfa-card-header-heading
                    >Order Item Details</sfa-card-header-heading
                  >
                </sfa-card-header>
                <sfa-card-content fxLayout="column">
                  <div fxLayout="column" fxFlex formGroupName="orderItemBatch">
                    <div
                      fxLayout="column"
                      fxLayout.gt-sm="row"
                      fxLayoutGap.gt-sm="24px"
                    >
                      <mat-form-field fxFlex appearance="standard">
                        <mat-label>Item Batch</mat-label>
                        <mat-select
                          formControlName="itemBatchId"
                          (ngModelChange)="
                            setSelectedSalesRepItemBatch(
                              form.value.orderItemBatch.itemBatchId
                            )
                          "
                          required
                        >
                          <mat-option
                            *ngFor="let itemBatch of itemBatches"
                            [value]="itemBatch.itemBatchId"
                            >{{ itemBatch.itemBatchName }}</mat-option
                          >
                        </mat-select>
                        <mat-hint>Please select a sales rep first.</mat-hint>
                      </mat-form-field>
                      <mat-form-field
                        class="sfa-flex-form-field"
                        fxFlex.gt-sm
                        appearance="standard"
                      >
                        <mat-label>Name</mat-label>
                        <input
                          type="text"
                          formControlName="name"
                          matInput
                          required
                        />
                      </mat-form-field>
                    </div>
                    <div
                      fxLayout="column"
                      fxLayout.gt-sm="row"
                      fxLayoutGap.gt-sm="24px"
                    >
                      <mat-form-field
                        class="sfa-flex-form-field"
                        fxFlex.gt-sm
                        appearance="standard"
                      >
                        <mat-label>Item Count</mat-label>
                        <input
                          type="number"
                          formControlName="itemCount"
                          matInput
                          required
                          max="{{
                            selectedSalesRepItemBatch
                              ? selectedSalesRepItemBatch.itemCount
                              : 100
                          }}"
                        />
                        <mat-hint *ngIf="selectedSalesRepItemBatch"
                          >{{ selectedSalesRepItemBatch.itemCount }} items
                          available</mat-hint
                        >
                      </mat-form-field>
                      <mat-form-field
                        class="sfa-flex-form-field"
                        fxFlex.gt-sm
                        appearance="standard"
                      >
                        <mat-label>Sell To Shop Owner Price</mat-label>
                        <input
                          type="number"
                          formControlName="sellingToShopOwnerAmount"
                          matInput
                        />
                      </mat-form-field>
                    </div>
                    <div
                      fxLayout="column"
                      fxLayout.gt-sm="row"
                      fxLayoutGap.gt-sm="24px"
                    >
                      <mat-form-field fxFlex appearance="standard">
                        <mat-label>Shop Owner Profit</mat-label>
                        <input
                          type="number"
                          formControlName="shopOwnerProfitAmount"
                          matInput
                        />
                      </mat-form-field>
                      <mat-form-field fxFlex appearance="standard">
                        <mat-label>Company Profit</mat-label>
                        <input
                          type="number"
                          formControlName="companyProfitAmount"
                          matInput
                        />
                      </mat-form-field>
                    </div>
                    <div
                      fxLayout="column"
                      fxLayout.gt-sm="row"
                      fxLayoutGap.gt-sm="24px"
                    >
                      <mat-form-field fxFlex appearance="standard">
                        <mat-label>Shop Owner Discount (%)</mat-label>
                        <input
                          type="number"
                          formControlName="shopOwnerDiscountRate"
                          matInput
                        />
                      </mat-form-field>
                      <mat-form-field fxFlex appearance="standard">
                        <mat-label>Company Discount (%)</mat-label>
                        <input
                          type="number"
                          formControlName="companyDiscountRate"
                          matInput
                        />
                      </mat-form-field>
                    </div>
                    <mat-form-field
                      class="sfa-flex-form-field"
                      fxFlex.gt-sm
                      appearance="standard"
                    >
                      <mat-label>Special Discount</mat-label>
                      <mat-select
                        formControlName="isSpecialDiscountHave"
                        required
                      >
                        <mat-option [value]="0">No</mat-option>
                        <mat-option [value]="1">Yes</mat-option>
                      </mat-select>
                    </mat-form-field>
                    <div
                      fxLayout="column"
                      fxLayout.gt-sm="row"
                      fxLayoutGap.gt-sm="24px"
                    >
                      <mat-form-field fxFlex appearance="standard">
                        <mat-label>Customer Free Issue</mat-label>
                        <input
                          type="number"
                          formControlName="customerFreeIssueQuantity"
                          matInput
                        />
                      </mat-form-field>
                      <mat-form-field fxFlex appearance="standard">
                        <mat-label>Shop Owner Free Issue</mat-label>
                        <input
                          type="number"
                          formControlName="shopOwnerFreeIssueQuantity"
                          matInput
                        />
                      </mat-form-field>
                    </div>
                    <div fxLayoutAlign="end center">
                      <button
                        type="button"
                        mat-mini-fab
                        color="accent"
                        mat-raised-button
                        [disabled]="form.value.orderItemBatch.invalid"
                        (click)="AddOrderItemBatch(form.value.orderItemBatch)"
                      >
                        <mat-icon>add</mat-icon>
                      </button>
                    </div>
                  </div>
                </sfa-card-content>
              </div>
            </div>
            <div fxLayout="column" fxLayout.gt-sm="row">
              <mat-hint *ngIf="orderItemBatches.length == 0"
                >Add at least one item to proceed.</mat-hint
              >
              <table
                [dataSource]="dataSource"
                mat-table
                matSort
                width="100%"
                *ngIf="orderItemBatches.length > 0"
              >
                <!-- fullName Column -->
                <ng-container *ngFor="let column of columns">
                  <ng-container
                    *ngIf="column.isModelProperty && !column.isList"
                    [matColumnDef]="column.property"
                  >
                    <th *matHeaderCellDef mat-header-cell mat-sort-header>
                      {{ column.name }}
                    </th>
                    <td *matCellDef="let row" mat-cell>
                      {{ row[column.property] }}
                    </td>
                  </ng-container>
                </ng-container>

                <!-- actions Column -->
                <ng-container matColumnDef="actions">
                  <th
                    *matHeaderCellDef
                    class="actions-cell"
                    mat-header-cell
                    mat-sort-header
                  ></th>
                  <td
                    *matCellDef="let row; let i = index"
                    class="actions-cell"
                    mat-cell
                  >
                    <button
                      type="button"
                      matTooltip="Remove"
                      (click)="
                        removeOrderItemBatch(i, row); $event.stopPropagation()
                      "
                      mat-icon-button
                    >
                      <mat-icon color="warn">delete</mat-icon>
                    </button>
                  </td>
                </ng-container>
                <tr *matHeaderRowDef="visibleColumns" mat-header-row></tr>
                <tr
                  *matRowDef="let row; columns: visibleColumns"
                  class="clickable route-animations-elements"
                  mat-row
                ></tr>
              </table>
            </div>
            <sfa-card-actions
              fxLayout="row"
              fxLayoutAlign="end center"
              fxLayoutGap="8px"
            >
              <button
                *ngIf="isCreateMode()"
                [disabled]="form.pristine"
                color="primary"
                mat-button
                type="reset"
              >
                RESET
              </button>
              <button
                *ngIf="isCreateMode()"
                mat-button
                [disabled]="form.invalid && orderItemBatches.length > 0"
                color="primary"
                mat-raised-button
              >
                CREATE
              </button>
              <button
                *ngIf="isUpdateMode()"
                mat-button
                [disabled]="form.invalid || form.pristine"
                color="primary"
                mat-raised-button
              >
                UPDATE
              </button>
            </sfa-card-actions>
          </form>
        </div>
      </sfa-card>
    </div>
  </sfa-page-layout-content>
</sfa-page-layout>
